# Getad_DB

## Описание

Веб-сервер предоставляющий простой веб-интерфейс взаимодействия с базой данных, собираемых службой **getad-service**: <br>https://github.com/symp1ex/getad-service

На данный момент имеется: 

- поиск по всем полям БД

- отдельный отчёт по истекающим ФН

- возможность загрузить информацию об отмеченных ККТ в **`.csv`**-файл для дальнейшего импорта в Excel\Google-таблицы

- удаление ККТ из базы с подчищением всех хвостов

- настраиваемая фильтрация устаревших записей о ККТ

- страница с настройками веб-сервера

- файловый менеджер, позволяющий через веб-интерфейс выгружать из контейнера файлы базы данных и файлы логов

## Требования

- Python 3.11 64-bit

## Сборка

### Команда на сборку docker-образа

```bash
docker build -t getad_db_img .
```

### Команда на запуск docker-контейнера

```bash
docker run -d --network host --restart=always -e TZ=Etc/GMT-3 --name getad_db getad_db_img

```
**`--restart=always`**: является обязательным параметром

Если нужен доступ к базе, **`config.ini`** или файлам логов из под файловой системы хоста, то можно примонтировать соответствующий каталог.

Пример команды на запуск docker-контейнера с примонтированным каталогом:

```bash
docker run -d --network host -v /home/user/service/getad_db/source/:/app/source --restart=always -e TZ=Etc/GMT-3 --name getad_db getad_db_img
```

### Дополнительная настройка хоста

По не понятным для меня пока причинам, периодически зависает обновление базы ККТ.
На текущий момент временным решением является добавление в **`crontab`** записи на перезапуск контейнера раз в 8-12 часов:

```bash
crontab -e
```

```bash
0 */8 * * * sudo docker restart <container_id>
```

## Конфигурация

### Настройка и первый запуск

Конфигурацию можно настроить заранее через **`config.ini`**  перед сборкой контейнера или из под самого веб-сервера после запуска. 

Настройки по умолчанию: 

Порт: **`30005`**

Логин: **`admin`**

Пароль: **`4321`**

После запуска контейнера в браузере переходим на **`0.0.0.0:30005`**, проходим авторизацию и открываем страницу с настройками. Там меняем учётные данные пользователей и прописываем настройки подключения к FTP-серверу.

Кнопка **`Сохранить`** перезаписывает конфиг и перезапускает контейнер с новыми настройками.

### Описание файла конфигурации

```ini
[global]
logs-autoclear-days = 14

[webserver]
port = 30005
user = user
pass = 1234
admin = admin
admin_pass = 4321

[ftp-connect]
ftphost = 
ftpuser = 
ftppass = 

[db-update]
db-name = dbpos
dbupdate-period-sec = 900
day_filter_expire = 5
```

Глобальные настройки:
- `logs-autoclear-days`: количество дней, за которое хранятся файлы логов

Настройки веб-сервера:
- `port`: TCP-порт, на котором запускается веб-сервер
- `user`: логин пользователя
- `pass`: пароль пользователя
- `admin`: логин администратора
- `admin_pass`: пароль администратора

Настройки FTP-сервера:
- `ftphost`: адрес FTP-сервера
- `ftpuser`: логин 
- `ftppass`: пароль

Настройки базы данных:
- `db-name`: имя файла базы данных или путь относительно **`/app/source`**
- `dbupdate-period-sec`: период обновления базы данных (сек.)
- `day_filter_expire`: количество дней, после которых запись о ККТ считается просроченной и начинает подсвечиваться в таблицах (перестаёт отображаться в отчёте по истекающим ФН)

## Примечания

- обычному пользователю недоступны возможность удаления ККТ из базы и страница с настройками\файловый менеджер
- файловый менеджер на странице с настройками не отображает **`.ini`**-файлы и каталоги глубже первого уровня вложенности в целях безопасности

