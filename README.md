# Getad_DB

## Описание

Веб-сервер, предоставляющий простой веб-интерфейс взаимодействия с базой данных, собираемых службой **getad-service**: <br>https://github.com/symp1ex/getad-service

На данный момент имеется: 

- поиск по всем полям БД

- отдельный отчёт по истекающим ФН

- интеграция с Битрикс24, создающая задачи за 30 дней до окончания ФН

- возможность загрузить информацию об отмеченных ККТ в **`.csv`**-файл для дальнейшего импорта в Excel\Google-таблицы

- удаление ККТ из базы

- настраиваемая фильтрация устаревших записей о ККТ

- страница с настройками веб-сервера

- файловый менеджер, позволяющий через веб-интерфейс выгружать из контейнера файлы логов

## Требования

- Python 3.11 64-bit

- PostgreSQL 15

## Сборка

### Команда на сборку docker-образа

```bash
docker build -t getad_db_img .
```

### Команда на запуск docker-контейнера

```bash
docker run -d --network host --restart=always -e TZ=Etc/GMT-3 --name getad_db getad_db_img

```
**`--restart=always`**: является обязательным параметром

Если нужен доступ к **`config.ini`** или файлам логов из под файловой системы хоста, то можно примонтировать соответствующий каталог.

Пример команды на запуск docker-контейнера с примонтированным каталогом:

```bash
docker run -d --network host -v /home/user/service/getad_db/source/:/app/source --restart=always -e TZ=Etc/GMT-3 --name getad_db getad_db_img
```

## Конфигурация

### Настройка и первый запуск

Конфигурацию можно настроить заранее через **`config.ini`**  перед сборкой контейнера или из под самого веб-сервера после запуска. 

Настройки по умолчанию: 

Порт: **`30005`**

Логин: **`admin`**

Пароль: **`4321`**

После запуска контейнера в браузере переходим на **`0.0.0.0:30005`**, проходим авторизацию и открываем страницу с настройками. Там меняем учётные данные пользователей, прописываем настройки подключения к FTP-серверу и базе данных PostgreSQL.

Кнопка **`Сохранить`** перезаписывает конфиг и перезапускает контейнер с новыми настройками.

### Описание файла конфигурации

<details>
<summary><b>config.ini</b></summary>

```ini
[global]
log-level = info
logs-autoclear-days = 14

[webserver]
port = 30005
user = user
pass = 1234
admin = admin
admin_pass = 4321

[db-update]
reference = 1
db-name = getad
host = localhost
port = 5432
user = 
password = 
dbupdate-period-sec = 900
day_filter_expire = 5

[ftp-connect]
ftphost = 
ftpuser = 
ftppass = 
```

Глобальные настройки:
- `log-level`: уровень логирования
- `logs-autoclear-days`: количество дней, за которое хранятся файлы логов

Настройки веб-сервера:
- `port`: TCP-порт, на котором запускается веб-сервер
- `user`: логин пользователя
- `pass`: пароль пользователя
- `admin`: логин администратора
- `admin_pass`: пароль администратора

Настройки базы данных:
- `reference`: 1/0 - включает или отключает обновление БД
- `db-name`: имя базы данных
- `host`: адрес подключения к серверу PostgreSQL
- `port`: порт подключения к серверу PostgreSQL
- `user`: имя пользователя PostgreSQL
- `password`: пароль
- `dbupdate-period-sec`: период обновления базы данных (сек.)
- `day_filter_expire`: количество дней, после которых запись о ККТ считается просроченной и начинает подсвечиваться в таблицах (перестаёт отображаться в отчёте по истекающим ФН)

Настройки FTP-сервера:
- `ftphost`: адрес FTP-сервера
- `ftpuser`: логин 
- `ftppass`: пароль


</details>

## Интеграция с Битрикс 24

### Настройка со стороны Битрикс 24

Требуется создать входящий вебхук и добавить к нему следующие права: **`user`**, **`user_basic`**, **`user.userfield`**, **`task`**, **`sonet_group`**

Пример вебхука: https://mycompany.bitrix24.ru/rest/123/z22n2q23548bnm23/

Важно чтобы у пользователя, под которым создаётся входящий вебхук, так же были эти права. Т.к. задачи будут создаваться от имени этого пользователя.

В разделе проекты необходимо создать проект и добавить в него тех сотрудников, которые должны будут иметь доступ к создаваемым задачам. Если доступ должен быть только у ответственного, всё равно создайте проект, но не добавляйте в него других сотрудников.

### Настройка со стороны веб-сервера

В настройках через веб-интерфейс или в **`bitrix24.json`** необходимо прописать полученный вебхук. Там же можно поменять количество попыток сделать запрос к API Битрикс 24, в случае неудачи или изменить таймаут между попытками.

При первом запуске веб-сервера на чистой БД, не рекомендуется сразу включать интеграцию. Лучше подождать первоначальной прогрузки базы ККТ и клиентов, в противном случае, первые несколько задач прилетят в Битрикс с названием клиента <b>"Неизвестно"</b>. Когда в очереди несколько задач на создание, интеграция отправляет запросы с интервалом в 10 минут.

Имена клиентов запрашиваются у RMS-сервера и посмотреть их можно в отчёте по истекающим ФН. На странице этого же отчёта их можно изменить.

При создании интеграцией задачи, в отчёте по истекающим ФН так же проставляется отметка о том, что задача была создана. При включенной интеграции эту отметку нельзя снять вручную, но можно её поставить. В таком случае на данный ФН задача автоматически создана не будет.

После включения интеграции придётся подождать ещё в районе минуты, пока в базу будут добавлены списки активных сотрудников и проектов. После их появления, останется в настройках веб-интерфейса выбрать ответственного сотрудника и проект, участникам которого будет дан доступ к созданным задачам.
	
<details>
<summary><b>Пример задачи</b></summary>

*<u>Заголовок:</u>*<br>
Кончается ФН 2025-10-07, Ресторан у Дома

*<u>Описание:</u>*<br>
Клиент: Ресторан у Дома<br>
Серийный номер: 00123456789098<br>
РНМ: 000123456789098<br>
Номер ФН: 123456789098<br>
Юр.лицо: ООО "Ресторан у Дома"<br>
ИНН: 9876543210<br>
Дата окончания: 2025-10-07

</details>

### Описание файла конфигурации

<details>
<summary><b>bitrix24.json</b></summary>

```json
{
    "enabled": 1,
    "webhook_url": "https://mycompany.bitrix24.ru/rest/123/z22n2q23548bnm23/",
    "count_attempts": 5,
    "timeout": 15
}
```

- `enabled`: включение\отключении интеграции
- `webhook_url`: url-адрес вебхука
- `count_attempts`: количество попыток сделать запрос к API
- `timeout`: таймаут между попытками

</details>

## Примечания

- обычному пользователю недоступны возможность удаления ККТ из базы и страница с настройками\файловый менеджер
- в целях безопасности файловый менеджер на странице с настройками не отображает **`.ini`** или **`.json`** файлы и каталоги глубже первого уровня вложенности

