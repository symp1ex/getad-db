# Getad_DB

## Описание

Веб-сервер, предоставляющий простой веб-интерфейс взаимодействия с базой данных, собираемых службой **getad-service**: <br>https://github.com/symp1ex/getad-service

На данный момент имеется: 

- поиск по всем полям БД

- отдельный отчёт по истекающим ФН

- API на приём и отдачу информации о ККТ

- интеграция с Битрикс24, создающая задачи за указанное количество дней до окончания ФН

- возможность загрузить информацию об отмеченных ККТ в **`.csv`**-файл для дальнейшего импорта в Excel\Google-таблицы

- удаление ККТ из базы

- настраиваемая фильтрация устаревших записей о ККТ

- страница с настройками веб-сервера

- файловый менеджер, позволяющий через веб-интерфейс выгружать из контейнера файлы логов

## Требования

- Python 3.11 64-bit

- PostgreSQL 15

## Сборка

### Команда на сборку docker-образа

```bash
docker build -t getad_db_img .
```

### Команда на запуск docker-контейнера

```bash
docker run -d --network host --restart=always -e TZ=Etc/GMT-3 --name getad_db getad_db_img

```
**`--restart=always`**: является обязательным параметром

Если нужен доступ к **`config.ini`** или файлам логов из под файловой системы хоста, то можно примонтировать соответствующий каталог.

Пример команды на запуск docker-контейнера с примонтированным каталогом:

```bash
docker run -d --network host -v /home/user/service/getad_db/source/:/app/source --restart=always -e TZ=Etc/GMT-3 --name getad_db getad_db_img
```

## Конфигурация

### Настройка и первый запуск

Конфигурацию можно настроить заранее через **`config.ini`**  перед сборкой контейнера или из под самого веб-сервера после запуска. 

Настройки по умолчанию: 

Порт: **`30005`**

Логин: **`admin`**

Пароль: **`4321`**

После запуска контейнера в браузере переходим на **`0.0.0.0:30005`**, проходим авторизацию и открываем страницу с настройками. Там меняем учётные данные пользователей, прописываем настройки подключения к FTP-серверу и базе данных PostgreSQL.

Кнопка **`Сохранить`** перезаписывает конфиг и перезапускает контейнер с новыми настройками.

### Описание файла конфигурации

<details>
<summary><b>config.ini</b></summary>

```ini
[global]
log-level = info
logs-autoclear-days = 14

[webserver]
port = 30005
user = user
pass = 1234
admin = admin
admin_pass = 4321

[db-update]
reference = 1
db-name = getad
host = localhost
port = 5432
user = 
password = 
dbupdate-period-sec = 900
day_filter_expire = 5

[ftp-connect]
ftp_backup = 0
ftp_update = 0
ftphost = 
ftpuser = 
ftppass = 
```

Глобальные настройки:
- `log-level`: уровень логирования
- `logs-autoclear-days`: количество дней, за которое хранятся файлы логов

Настройки веб-сервера:
- `port`: TCP-порт, на котором запускается веб-сервер
- `user`: логин пользователя
- `pass`: пароль пользователя
- `admin`: логин администратора
- `admin_pass`: пароль администратора

Настройки базы данных:
- `reference`: 1/0 - включает или отключает обновление БД этим экземпляром сервера (не влияет на возможность сохранение данных, полученных по API)
- `db-name`: имя базы данных
- `host`: адрес подключения к серверу PostgreSQL
- `port`: порт подключения к серверу PostgreSQL
- `user`: имя пользователя PostgreSQL
- `password`: пароль
- `dbupdate-period-sec`: период обновления базы данных (сек.)
- `day_filter_expire`: количество дней, после которых запись о ККТ считается просроченной и начинает подсвечиваться в таблицах (перестаёт отображаться в отчёте по истекающим ФН)

Настройки FTP-сервера:
- `ftp_backup`: резервное копирование полученных по API json-файлов на FTP-сервер
- `ftp_update`: включает обновление БД с FTP-сервера
- `ftphost`: адрес FTP-сервера
- `ftpuser`: логин 
- `ftppass`: пароль


</details>

## API

### Описание

API-ключи хранятся в БД и управляются исключительно со страницы с настройками через веб-интерфейс. Ключи могу быть с правами "пользователя" или "администратора". Пользователю не доступны методы, вносящие изменения в БД.

Каждый метод содержит следующий список заголовков:
```python
{
    'Content-Type': 'application/json',
    'X-API-Key': api_key
}
```
### API-методы

**`POST`** **/api/submit_json**

Метод добавляющий в базу информацию о ККТ, полученную от агента на клиентской станции

<details>
<summary><b>Пример запроса</b></summary>

```json
{
	"modelName": "АТОЛ 22 v2 Ф",
	"serialNumber": "00123456790012",
	"RNM": "0000000001036518",
	"organizationName": "ООО Предприятие",
	"fn_serial": "7380440700067159",
	"datetime_reg": "2024-04-13 07:20:00",
	"dateTime_end": "2099-12-31 00:00:00",
	"ofdName": "ООО Эвотор ОФД",
	"bootVersion": "5.8.100",
	"ffdVersion": "105",
	"INN": "1111222233  ",
	"address": "г.Москва, Тверская ул, д.1, стр. 333",
	"attribute_excise": "True",
	"attribute_marked": "False",
	"fnExecution": "Эмулятор ФН с поддержкой ФФД 1.2",
	"installed_driver": "10.9.1.0",
	"licenses": {
		"1": {
			"name": "Фискальные функции",
			"dateFrom": "2018-11-21 00:00:00",
			"dateUntil": "2038-01-19 03:14:07"
		},
		"10": {
			"name": "ФФД 1.2",
			"dateFrom": "2019-12-26 00:00:00",
			"dateUntil": "2038-01-19 03:14:07"
		}
	},
	"hostname": "Isaac-LT",
	"url_rms": "https://resto.iiko.it:443/resto",
	"teamviewer_id": "111222333",
	"anydesk_id": "222333444",
	"litemanager_id": "ID_1111",
	"current_time": "2024-05-05 21:57:25",
	"v_time": "2024-05-05 21:57:25",
	"uuid": "6cb34107-cfb2-9ba1-b1ff-4823d63ea8d7"
}
```
</details>

<br>**`GET`** **/api/get_serial_numbers**

Метод возвращающий список серийных номеров всех ККТ в базе

<details>
<summary><b>Пример запроса</b></summary>

```json
{
    "clients_info": false
}
```
При `"clients_info": true` в ответе так же приходят юр.лицо, инн, имя и адрес rms сервера

</details>

<details>
<summary><b>Пример ответа</b></summary>

```json
[
    "00111112222333",
    "044444333332222"
]
```

</details>

<br>**`GET`** **/api/get_fiscals_data**

Метод возвращающий полную информацию о ККТ в ответ на полученный список серийных номеров

<details>
<summary><b>Пример запроса</b></summary>

```json
[
    "00111112222333",
    "044444333332222"
]
```

</details>

<details>
<summary><b>Пример ответа</b></summary>

```json
[
    {
        "modelName": "АТОЛ 22 v2 Ф",
        "serialNumber": "00111112222333",
        "RNM": "00111112222333",
        "organizationName": "ООО Кафе",
        "fn_serial": "00111112222333",
        "datetime_reg": "2024-04-13 07:20:00",
        "dateTime_end": "2099-12-31 00:00:00",
        "ofdName": "ООО Эвотор ОФД",
        "bootVersion": "5.8.100",
        "ffdVersion": "105",
        "INN": "1111222233  ",
        "address": "г.Москва, Тверская ул, д.1, стр. 333",
        "attribute_excise": "True",
        "attribute_marked": "False",
        "fnExecution": "Эмулятор ФН с поддержкой ФФД 1.2",
        "installed_driver": "10.9.1.0",
        "licenses": {
            "1": {
                "name": "Фискальные функции",
                "dateFrom": "2018-11-21 00:00:00",
                "dateUntil": "2038-01-19 03:14:07"
            },
            "10": {
                "name": "ФФД 1.2",
                "dateFrom": "2019-12-26 00:00:00",
                "dateUntil": "2038-01-19 03:14:07"
            }
        },
        "hostname": "Isaac-LT",
        "url_rms": "https://resto.iiko.it:443/resto",
        "teamviewer_id": "111222333",
        "anydesk_id": "222333444",
        "litemanager_id": "ID_1111",
        "current_time": "2024-05-05 21:57:25",
        "v_time": "2024-05-05 21:57:25",
        "uuid": "6cb34107-cfb2-9ba1-b1ff-4823d63ea8d7"
    },
    {
        "modelName": "АТОЛ 22 v2 Ф",
        "serialNumber": "044444333332222",
        "RNM": "044444333332222",
        "organizationName": "ИП Иванов И.И.",
        "fn_serial": "044444333332222",
        "datetime_reg": "2024-04-13 07:20:00",
        "dateTime_end": "2099-12-31 00:00:00",
        "ofdName": "ООО Эвотор ОФД",
        "bootVersion": "5.8.100",
        "ffdVersion": "105",
        "INN": "1111222233  ",
        "address": "г.Москва, Тверская ул, д.1, стр. 222",
        "attribute_excise": "True",
        "attribute_marked": "False",
        "fnExecution": "Эмулятор ФН с поддержкой ФФД 1.2",
        "installed_driver": "10.9.1.0",
        "licenses": {
            "1": {
                "name": "Фискальные функции",
                "dateFrom": "2018-11-21 00:00:00",
                "dateUntil": "2038-01-19 03:14:07"
            },
            "10": {
                "name": "ФФД 1.2",
                "dateFrom": "2019-12-26 00:00:00",
                "dateUntil": "2038-01-19 03:14:07"
            }
        },
        "hostname": "Isaac-PC",
        "url_rms": "https://resto.iiko.it:443/resto",
        "teamviewer_id": "111222333",
        "anydesk_id": "222333444",
        "litemanager_id": "ID_1111",
        "current_time": "2024-05-05 21:57:25",
        "v_time": "2024-05-05 21:57:25",
        "uuid": "690b3ca6-b2c3-47c1-8292-67bd1e67a2bc"
    }
]
```

</details>

<br>**`GET`** **/api/get_pos_data**

Метод возвращающий все записи из таблицы с информацией о станциях, тело запроса должно быть пустым

<details>
<summary><b>Пример ответа</b></summary>

```json
[
    {
        "anydesk_id": "None",
        "current_time": "2025-09-02 13:55:01",
        "filename": "TV111222333_ADNone.json",
        "hostname": "Isaac-PC",
        "litemanager_id": "None",
        "teamviewer_id": "1007195806",
        "url_rms": "https://resto.iiko.it:443/resto",
        "uuid": null,
        "vc": "2.1.3.1"
    },
    {
        "anydesk_id": "None",
        "current_time": "2025-08-14 17:52:00",
        "filename": "TV111222333_ADNone.json",
        "hostname": "Isaac-LT",
        "litemanager_id": "MH_11111",
        "teamviewer_id": "111222333",
        "url_rms": "https://resto.iiko.it:443/resto",
        "uuid": null,
        "vc": null
    }
]
```

</details>

## Интеграция с Битрикс24

### Настройка со стороны Битрикс24

Требуется создать входящий вебхук и добавить к нему следующие права: **`user`**, **`user_basic`**, **`user.userfield`**, **`task`**, **`sonet_group`**

Пример вебхука: https://mycompany.bitrix24.ru/rest/123/z22n2q23548bnm23/

Важно чтобы у пользователя, под которым создаётся входящий вебхук, так же были эти права. Т.к. задачи будут создаваться от имени этого пользователя.

В разделе проекты необходимо создать проект и добавить в него тех сотрудников, которые должны будут иметь доступ к создаваемым задачам. Если доступ должен быть только у ответственного, всё равно создайте проект, но не добавляйте в него других сотрудников.

### Настройка со стороны веб-сервера

В настройках через веб-интерфейс или в **`bitrix24.json`** необходимо прописать полученный вебхук. Там же можно поменять количество попыток сделать запрос к API Битрикс24, в случае неудачи или изменить таймаут между попытками.

Имена клиентов запрашиваются у RMS-сервера и посмотреть их можно в отчёте по истекающим ФН. На странице этого же отчёта их можно изменить.

При создании интеграцией задачи, в отчёте по истекающим ФН так же проставляется отметка о том, что задача была создана. При включенной интеграции эту отметку нельзя снять вручную, но можно её поставить. В таком случае на данный ФН задача автоматически создана не будет.

После включения интеграции придётся подождать ещё в районе минуты, пока в базу будут добавлены списки активных сотрудников и проектов. После их появления, останется в настройках веб-интерфейса выбрать ответственного сотрудника и проект, участникам которого будет дан доступ к созданным задачам.
	
<details>
<summary><b>Пример задачи</b></summary>

*<u>Заголовок:</u>*<br>
Кончается ФН 2025-10-07, Ресторан у Дома

*<u>Описание:</u>*<br>
Клиент: Ресторан у Дома<br><br>
Серийный номер: 00123456789098<br>
РНМ: 000123456789098<br>
Номер ФН: 123456789098<br><br>
Юр.лицо: ООО "Ресторан у Дома"<br>
ИНН: 9876543210<br>
Адрес места расчётов: "г.Москва, Тверская ул, д.1, стр. 333"<br><br>
Дата окончания: 2025-10-07

</details>

### Описание файла конфигурации

<details>
<summary><b>bitrix24.json</b></summary>

```json
{
    "enabled": 1,
    "webhook_url": "https://mycompany.bitrix24.ru/rest/123/z22n2q23548bnm23/",
    "count_attempts": 5,
    "timeout": 15,
    "create_tasks_of_days": 30
}
```

- `enabled`: включение\отключении интеграции
- `webhook_url`: url-адрес вебхука
- `count_attempts`: количество попыток сделать запрос к API
- `timeout`: таймаут между попытками
- `create_tasks_of_days`: определяет за сколько дней до окончания ФН будет создана задача

</details>

## Примечания

- обычному пользователю недоступны возможность удаления ККТ из базы и страница с настройками\файловый менеджер
- в целях безопасности файловый менеджер на странице с настройками не отображает **`.ini`** или **`.json`** файлы и каталоги глубже первого уровня вложенности

