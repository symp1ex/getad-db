<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <title>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
</head>
<body>
    <div class="background-layer"></div>
    <div class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center;">
                <a href="{{ url_for('index') }}">
                    <img src="{{ url_for('static', filename='home.png') }}" class="home-icon" alt="Home">
                </a>
                <a href="{{ url_for('logout') }}" class="logout-icon">
                    <img src="{{ url_for('static', filename='logout.png') }}" alt="Logout">
                </a>
                <h1 style="margin: 0;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="tab" onclick="switchTab('integrations')">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</button>
            <button class="tab" onclick="switchTab('files')">–§–∞–π–ª—ã</button>
        </div>

        <div id="settings" class="tab-content active">
            <form id="settingsForm">
                <div class="settings-group">
                    <h3>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="setting-item">
                        <label for="global.log-level">–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                        <select class="form-control" name="global.log-level" id="global.log-level">
                            <option value="debug" {% if config.get('global', 'log-level') == 'debug' %}selected{% endif %}>DEBUG</option>
                            <option value="info" {% if config.get('global', 'log-level') == 'info' %}selected{% endif %}>INFO</option>
                            <option value="warning" {% if config.get('global', 'log-level') == 'warning' %}selected{% endif %}>WARNING</option>
                            <option value="error" {% if config.get('global', 'log-level') == 'error' %}selected{% endif %}>ERROR</option>
                            <option value="critical" {% if config.get('global', 'log-level') == 'critical' %}selected{% endif %}>CRITICAL</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="logs-autoclear-days">–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ (–¥–Ω–µ–π)</label>
                        <input type="number" id="logs-autoclear-days" name="global.logs-autoclear-days"
                               value="{{ config['global']['logs-autoclear-days'] }}">
                    </div>
                </div>

                <div class="settings-group">
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞</h3>
                    <div class="setting-item">
                        <label for="port">–ü–æ—Ä—Ç</label>
                        <input type="number" id="port" name="webserver.port"
                               value="{{ config['webserver']['port'] }}">
                    </div>
                    <div class="setting-item">
                        <label for="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                        <input type="text" id="user" name="webserver.user"
                               value="{{ config['webserver']['user'] }}">
                    </div>
                    <div class="setting-item">
                        <label for="pass">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="pass" name="webserver.pass"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="setting-item">
                        <label for="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</label>
                        <input type="text" id="admin" name="webserver.admin"
                               value="{{ config['webserver']['admin'] }}">
                    </div>
                    <div class="setting-item">
                        <label for="admin_pass">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                        <input type="password" id="admin_pass" name="webserver.admin_pass"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>

                <div class="settings-group">
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h3>
                    <div class="setting-item setting-item-checkbox">
                        <label for="reference">–≠—Ç–∞–ª–æ–Ω</label>
                        <input type="checkbox" id="reference" name="db-update.reference" 
                            {% if config['db-update']['reference'] == '1' %}checked{% endif %}
                            value="1">
                    </div>
                    <div class="setting-item">
                        <label for="db-name">–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</label>
                        <input type="text" id="db-name" name="db-update.db-name"
                               value="{{ config['db-update']['db-name'] }}">
                    </div>
                    <div class="setting-item">
                        <label for="host">–ê–¥—Ä–µ—Å</label>
                        <input type="text" id="host" name="db-update.host"
                               value="{{ config['db-update']['host'] }}">
                    </div>    
                    <div class="setting-item">
                        <label for="port">–ü–æ—Ä—Ç</label>
                        <input type="number" id="port" name="db-update.port"
                               value="{{ config['db-update']['port'] }}">
                    </div>   
                    <div class="setting-item">
                        <label for="user">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" id="user" name="db-update.user"
                               value="{{ config['db-update']['user'] }}">
                    </div>   
                    <div class="setting-item">
                        <label for="password">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="password" name="db-update.password"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>                                                                        
                    <div class="setting-item">
                        <label for="dbupdate-period-sec">–ü–µ—Ä–∏–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–µ–∫)</label>
                        <input type="number" id="dbupdate-period-sec" name="db-update.dbupdate-period-sec"
                               value="{{ config['db-update']['dbupdate-period-sec'] }}">
                    </div>
                    <div class="setting-item">
                        <label for="day_filter_expire">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (–¥–Ω–µ–π)</label>
                        <input type="number" id="day_filter_expire" name="db-update.day_filter_expire"
                               value="{{ config['db-update']['day_filter_expire'] }}">
                    </div>
                </div>

                <div class="settings-group">
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ FTP</h3>
                    <div class="setting-item">
                        <label for="ftpHost">FTP —Ö–æ—Å—Ç</label>
                        <input type="text" id="ftpHost" name="ftp-connect.ftpHost"
                               value="{{ config['ftp-connect']['ftpHost'] }}">
                    </div>
                    <div class="setting-item">
                        <label for="ftpUser">FTP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                        <input type="text" id="ftpUser" name="ftp-connect.ftpUser"
                               value="{{ config['ftp-connect']['ftpUser'] }}">
                    </div>
                    <div class="setting-item">
                        <label for="ftpPass">FTP –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" id="ftpPass" name="ftp-connect.ftpPass"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>

                <div class="button-container">
                    <button type="button" class="button button-secondary" onclick="window.location.href='{{ url_for('settings') }}'">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="button button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>

        <div id="files" class="tab-content">
            <ul class="files-list">
                {% for item in files|sort(attribute='name')|sort(attribute='is_dir', reverse=true) %}
                    {% if item.is_dir %}
                        <li class="directory">
                            <div class="dir-header" onclick="toggleFiles('{{ item.name }}')">
                                <span class="folder-icon">üìÅ</span>
                                <span class="folder-name">{{ item.name }}</span>
                                <span class="toggle-icon" id="toggle-{{ item.name }}">‚ñ∂</span>
                            </div>
                        </li>
                        {% for subitem in item.files|sort(attribute='name') %}
                            <li class="file-item subfile" data-parent="{{ item.name }}" style="display: none;">
                                <span class="file-icon">üìÑ</span>
                                <span class="file-name">{{ subitem.name }}</span>
                                <a href="{{ url_for('download_file', filename=subitem.path) }}"
                                   class="download-button">–°–∫–∞—á–∞—Ç—å</a>
                            </li>
                        {% endfor %}
                    {% else %}
                        <li class="file-item">
                            <span class="file-icon">üìÑ</span>
                            <span class="file-name">{{ item.name }}</span>
                            <a href="{{ url_for('download_file', filename=item.path) }}"
                               class="download-button">–°–∫–∞—á–∞—Ç—å</a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>

        <div id="integrations" class="tab-content">
            <form id="integrationsForm">
                <div class="settings-group">
                    <h3>–ë–∏—Ç—Ä–∏–∫—Å24</h3>
                    <div class="setting-item setting-item-checkbox">
                        <label for="bitrix24-enabled">–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é</label>
                        <input type="checkbox" id="bitrix24-enabled" name="bitrix24.enabled" 
                            {% if bitrix_json['enabled'] == 1 %}checked{% endif %}
                            value="1">
                    </div>
                    <div class="setting-item">
                        <label for="webhook-url">Webhook URL</label>
                        <input type="password" id="webhook-url" name="bitrix24.webhook_url"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="setting-item">
                        <label for="count-attempts">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å</label>
                        <input type="number" id="count-attempts" name="bitrix24.count_attempts"
                            value="{{ bitrix_json['count_attempts'] }}">
                    </div>
                    <div class="setting-item">
                        <label for="timeout">–¢–∞–π–º-–∞—É—Ç –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (—Å–µ–∫)</label>
                        <input type="number" id="timeout" name="bitrix24.timeout"
                            value="{{ bitrix_json['timeout'] }}">
                    </div>
                    <div class="setting-item">
                        <label for="responsible-employee">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                        <select class="form-control" name="bitrix24.responsible" id="responsible-employee">
                            <option value="">None</option>
                            {% for emp in bitrix_employees %}
                                <option value="{{ emp.id }}" {% if emp.responsible == 1 %}selected{% endif %}>
                                    {{ emp.id }} - {{ emp.NAME }} {{ emp.LAST_NAME }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="observers-group">–ì—Ä—É–ø–ø–∞ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π</label>
                        <select class="form-control" name="bitrix24.observers" id="observers-group">
                            <option value="">None</option>
                            {% for group in bitrix_projects %}
                                <option value="{{ group.id }}" {% if group.observers == 1 %}selected{% endif %}>
                                    {{ group.id }} - {{ group.NAME }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

            <div class="button-container">
                <button type="button" class="button button-secondary" onclick="window.location.href='{{ url_for('settings') }}'">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="button button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            </form>
    </div>    

    <div id="notification" class="notification"></div>
    
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
</body>
</html>